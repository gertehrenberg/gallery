<form id="diffForm" action="/gallery/diff_gdrive_local_delete" method="post">

    <div class="sticky-bar">
        <button type="button" class="btn btn-blue" onclick="window.location.href='/gallery/dashboard'">üìä Dashboard
        </button>
        <button id="reloadBtn" type="button" class="btn btn-orange" onclick="startReload()">üîÑ Neu laden</button>
        <button id="deleteBtn" type="button" class="btn btn-red" onclick="checkAndSubmit()">üóë/üîÅ/‚úèÔ∏è Ausf√ºhren</button>
    </div>

    <!-- PROGRESS -->
    <div id="progressBox" style="display:none;">
        <div id="progressText" style="font-weight:bold;">Starte‚Ä¶</div>
        <div class="progress-bar-bg">
            <div id="mainBar" class="progress-bar"></div>
        </div>
        <div id="detailText" style="font-size:14px; margin-top:10px;">Bereit</div>
        <div class="progress-bar-bg">
            <div id="detailBar" class="progress-bar detail-bar"></div>
        </div>
    </div>

    <h2>Diff Tabelle</h2>

    <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
        <thead>
        <tr>
            <th style="width:40px;">‚úèÔ∏è</th>
            <th style="width:40px;">üîÅ</th>
            <th style="width:40px;">üóë</th>
            <th style="width:140px;">Bild</th>
            <th>Info</th>
            <th>Typ</th>
        </tr>
        </thead>

        <tbody>

        <!-- ========================================================= -->
        <!--  üî• DATEINAMEN-KONFLIKTE (new feature)                     -->
        <!-- ========================================================= -->
        {% if filename_collisions and filename_collisions|length > 0 %}
            {% for col in filename_collisions %}
                <tr style="background:#ffe0e0;">
                    <td colspan="6" style="padding:10px;">
                        <b>üî• Konflikt: Varianten: {{ col.md5_list|length }} ‚Äî {{ col.local|length }}x
                            local, {{ col.gdrive|length }}x gdrive
                        </b>
                    </td>
                </tr>

                <!-- Lokale Versionen -->
                {% for l in col.local %}
                    <tr>
                        <td class="center">
                            <input type="checkbox" name="unique_filename_ids" value="{{ l.path }}">
                        </td>
                        <td class="center"></td>
                        <td class="center">
                            <input type="checkbox" name="delete_ids" value="{{ l.path }}">
                        </td>
                        <td>
                            <img class="thumb"
                                 src="/gallery/static/thumbnails/{{ l.md5 }}.png"
                                 onclick="openModal('{{ l.folder }}/{{ l.name }}')">
                        </td>
                        <td>
                            <div>{{ l.folder }}</div>
                            <div>{{ l.path }}</div>
                            <div>{{ l.name }}</div>
                        </td>
                        <td>Lokal</td>
                    </tr>
                {% endfor %}

                <!-- GDrive Versionen -->
                {% for g in col.gdrive %}
                    <tr>
                        <td class="center">
                            <input type="checkbox" name="unique_filename_ids" value="{{ g.id }}">
                        </td>
                        <td class="center"></td>
                        <td class="center">
                            <input type="checkbox" name="delete_ids" value="{{ g.id }}">
                        </td>
                        <td>
                            <img class="thumb"
                                 src="https://drive.google.com/thumbnail?id={{ g.id }}&sz=w200"
                                 onclick="openModalGdrive('{{ g.id }}')">
                        </td>
                        <td>
                            <div>{{ g.folder }}</div>
                            <div>{{ g.id }}</div>
                            <div>{{ g.name }}</div>
                        </td>
                        <td>GDrive</td>
                    </tr>
                {% endfor %}

            {% endfor %}
        {% endif %}

        <!-- ========================================================= -->
        <!--   1) UNG√úLTIGE NAMEN ‚Äì IMMER OBEN                         -->
        <!-- ========================================================= -->
        {% for n in invalid_names %}
            <tr style="background:#fff3cd;">
                <!-- ‚úèÔ∏è rename -->
                {% if n.source == "local" %}
                    <td class="center">
                        <input type="checkbox"
                               name="rename_ids"
                               value="{{ n.uid }}">
                    </td>
                    <td class="center"></td>
                    <td class="center">
                        <input type="checkbox"
                               name="delete_ids"
                               value="{{ n.path }}">
                    </td>
                    <td>
                        <img class="thumb"
                             src="/gallery/static/thumbnails/{{ n.md5 }}.png"
                             onclick="openModal('{{ n.folder }}/{{ n.orig_name }}')"
                             style="cursor:pointer;">
                    </td>
                    <td>
                        <div>{{ n.folder }}</div>
                        <div>{{ n.path }}</div>
                        <div style="color:#d9534f;"><b>Ung√ºltig:</b> {{ n.orig_name | tojson }}</div>
                        <div><b>Neu:</b> {{ n.clean_name }}</div>
                    </td>
                {% else %}
                    <td class="center">
                        <input type="checkbox"
                               name="rename_ids"
                               value="{{ n.id }}">
                    </td>
                    <td class="center"></td>
                    <td class="center">
                        <input type="checkbox"
                               name="delete_ids"
                               value="{{ n.id }}">
                    </td>
                    <td>
                        <img class="thumb"
                             src="https://drive.google.com/thumbnail?id={{ n.id }}&sz=w200"
                             style="cursor:pointer;"
                             onclick="openModalGdrive('{{ n.id }}')">
                    </td>
                    <td>
                        <div>{{ n.folder }}</div>
                        <div>{{ n.id }}</div>
                        <div style="color:#d9534f;"><b>Ung√ºltig:</b> {{ n.orig_name | tojson }}</div>
                        <div><b>Neu:</b> {{ n.clean_name }}</div>
                    </td>
                {% endif %}
                <td>{{ n.source|capitalize }}</td>
            </tr>
        {% endfor %}

        <!-- ========================================================= -->
        <!--   2) MD5 FEHLER                                           -->
        <!-- ========================================================= -->
        {% for m in invalid_md5 %}
            <tr style="background:#ffe0e0;">
                <td colspan="6"
                    style="font-weight:bold; padding-top:12px; padding-bottom:12px;">
                    MD5: {{ m.md5 }} ‚Äî {{ m.status }}
                </td>
            </tr>

            <!-- ---------- GDRIVE FILES ---------- -->
            {% for g in m.gdrive %}
                <tr>

                    <td class="center"></td>

                    <!-- üîÅ sync wenn keine local Datei -->
                    <td class="center">
                        {% if m.local|length == 0 %}
                            <input type="checkbox" name="sync_ids" value="{{ g.id }}">
                        {% endif %}
                    </td>

                    <!-- üóë delete -->
                    <td class="center">
                        <input type="checkbox" name="delete_ids" value="{{ g.id }}">
                    </td>

                    <!-- Bild mit Vollbild-Link -->
                    <td>
                        <img class="thumb"
                             src="https://drive.google.com/thumbnail?id={{ g.id }}&sz=w200"
                             style="cursor:pointer;"
                             onclick="openModalGdrive('{{ g.id }}')">
                    </td>

                    <td>
                        <div>{{ g.folder }}</div>
                        <div>{{ g.id }}</div>
                        <div>{{ g.name }}</div>
                    </td>

                    <td>GDrive</td>
                </tr>
            {% endfor %}

            <!-- ---------- LOCAL FILES ---------- -->
            {% for l in m.local %}
                <tr>

                    <!-- ‚úèÔ∏è rename falls invalid -->
                    <td class="center"></td>

                    <!-- üîÅ sync wenn kein gdrive -->
                    <td class="center">
                        {% if m.gdrive|length == 0 %}
                            <input type="checkbox" name="sync_ids" value="{{ l.path }}">
                        {% endif %}
                    </td>

                    <!-- üóë delete -->
                    <td class="center">
                        <input type="checkbox" name="delete_ids" value="{{ l.path }}">
                    </td>

                    <!-- Lokales Bild ‚Üí Modal -->
                    <td>
                        <img class="thumb"
                             src="/gallery/static/thumbnails/{{ m.md5 }}.png"
                             onclick="openModal('{{ l.folder }}/{{ l.name }}')"
                             style="cursor:pointer;">
                    </td>

                    <td>
                        <div>{{ l.folder }}</div>
                        <div>{{ l.path }}</div>
                        <div>{{ l.name }}</div>
                    </td>

                    <td>Lokal</td>
                </tr>
            {% endfor %}
        {% endfor %}

        </tbody>
    </table>

</form>
