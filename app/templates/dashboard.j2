<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Gallery Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    {% include "dashboard_css.j2" %}
</head>
<body>
<div class="page">

    <div class="top-row">
        <div>
            <h1>Gallery Dashboard</h1>
            <div class="subtitle">
                √úbersicht &amp; Systemstatus
            </div>
        </div>
    </div>

    {# ============================
       √úbersicht
       ============================ #}
    <h2>√úbersicht</h2>

    <div class="overview-grid">

        {# 1 ‚Äì Kosten (Monat) #}
        <div class="overview-card">
            <div class="overview-card-header">
                <div class="overview-card-title">Kosten (Monat)</div>
                <div class="overview-card-icon">üí∞</div>
            </div>

            <div class="sys-row" style="border-top:none;">
                <div class="sys-row-header">
                    <div class="label">Gesamt</div>
                    <div class="overview-card-value">
                        {% set total_chf = info[1].kosten_chf if info|length > 1 and info[1].kosten_chf is defined else "CHF 0.0" %}
                        {{ total_chf }}
                    </div>
                </div>
                <div class="small">
                    Gesamtkosten f√ºr den ausgew√§hlten Monat.
                </div>
            </div>

            <div class="sys-row">
                <div class="sys-row-header">
                    <div class="label">Zeitraum</div>
                </div>
                <div class="small">
                    {{ info[0].from_to if info|length > 0 and info[0].from_to is defined else "unbekannt" }}
                </div>
            </div>

            <div class="sys-row">
                <div class="sys-row-header">
                    <div class="label">Dienste</div>
                </div>
                <div class="small">
                    Summe aus Google, OpenAI, RunPod, Hyperstack und Fixkosten.
                </div>
            </div>
        </div>

        {# 2 ‚Äì System #}
        {% set has_gs = gdrive_status is defined and gdrive_status %}
        {% set gs_ok = has_gs and gdrive_status.ok %}
        {% set gs_msg = gdrive_status.message if has_gs and gdrive_status.message is defined else 'Status unbekannt' %}

        <div class="overview-card">
            <div class="overview-card-header">
                <div class="overview-card-title">System</div>
                <div class="overview-card-icon">üß©</div>
            </div>

            <div class="sys-row">
                <div class="sys-row-header">
                    <div class="label">Google Drive</div>
                    <div class="status-pill {{ 'ok' if gs_ok else 'error' }}">
                        <span class="status-dot"></span>
                        {{ 'Online' if gs_ok else 'Offline' }}
                    </div>
                </div>
                <div class="small">
                    {{ gs_msg }}
                </div>
            </div>

            <div class="sys-row">
                <div class="sys-row-header">
                    <div class="label">Kategorien</div>
                    <div class="overview-card-value">
                        {{ gdrive_stats|length if gdrive_stats is defined else 0 }}
                    </div>
                </div>
                <div class="small">
                    Ordner mit Hash-/DB-Statistik
                </div>
            </div>

            <div class="muted" style="margin-top:8px;">
                Weitere Checks k√∂nnen hier sp√§ter erg√§nzt werden.
            </div>
        </div>
    </div>

    {# ============================
       Quick Links
       ============================ #}
    <h2>Quick Links</h2>
    <div class="card">
        <div class="card-header">
            <h3>Dienste &amp; Tools</h3>
            <small>Schnellzugriff</small>
        </div>

        <div style="margin-bottom:12px;">
            <strong>Services</strong>
            <div class="help-links" style="margin-top:6px;">
                {% for h in help_links %}
                    <a href="{{ h.url }}" target="_blank" class="chip-link">
                        <span class="icon">{{ h.icon }}</span>
                        <span>{{ h.label }}</span>
                    </a>
                {% endfor %}
            </div>
        </div>

        <div>
            <strong>Tools</strong>
            <div class="tool-links" style="margin-top:6px;">
                {% for t in tool_links %}
                    <a href="{{ t.url }}" class="chip-link">
                        <span class="icon">{{ t.icon }}</span>
                        <span>{{ t.label }}</span>
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>

    {# ============================
       GDrive vs. Local / DB
       ============================ #}
    <h2 style="margin-top:30px;">GDrive / Local / DB ‚Äì √úbersicht</h2>

    <div class="card">
        <div class="card-header">
            <h3>Hash- &amp; DB-Statistik</h3>
            <small>Abgleich pro Kategorie</small>
        </div>

        <div style="overflow-x:auto;">
            <table>
                <thead>
                <tr>
                    <th>Kat.</th>
                    <th>Ordner</th>
                    <th style="text-align:right;">GDrive-Hashes</th>
                    <th style="text-align:center;">Sync</th>
                    <th style="text-align:right;">Local-Hashes</th>
                    <th style="text-align:left;">DB-Cache</th>
                    <th>Hinweis</th>
                </tr>
                </thead>
                <tbody>
                {% for entry in gdrive_stats %}
                    {% set has_count_mismatch = entry.has_count_mismatch %}
                    {% set has_gdrive_mismatch = entry.has_gdrive_mismatch %}
                    <tr>
                        <td>{{ entry.icon }}</td>

                        <td>
                            <a href="/gallery?page=1&count=6&folder={{ entry.key }}&textflag=1">
                                {{ entry.label }}
                            </a>
                        </td>

                        <td style="text-align:right;"
                            class="{{ 'count-badge-error' if has_gdrive_mismatch else 'count-badge-ok' }}">
                            {{ entry.gdrive_count }}
                        </td>

                        <td style="text-align:center;">
                            <div style="display:flex; justify-content:center; gap:8px;">
                                <form action="/gallery/dashboard/test" method="get" style="margin:0;">
                                    <input type="hidden" name="folder" value="{{ entry.key }}">
                                    <input type="hidden" name="direction" value="gdrive_zu_local">
                                    <button type="submit" title="GDrive ‚Üí Lokal"
                                            style="background:none;border:none;color:inherit;cursor:pointer;">
                                        ‚Üí
                                    </button>
                                </form>
                                <form action="/gallery/dashboard/test" method="get" style="margin:0;">
                                    <input type="hidden" name="folder" value="{{ entry.key }}">
                                    <input type="hidden" name="direction" value="lokal_zu_gdrive">
                                    <button type="submit" title="Lokal ‚Üí GDrive"
                                            style="background:none;border:none;color:inherit;cursor:pointer;">
                                        ‚Üê
                                    </button>
                                </form>
                            </div>
                        </td>

                        <td style="text-align:right;">
                            {% if has_count_mismatch %}
                                <span class="count-badge-error">{{ entry.local_count }}</span>
                            {% else %}
                                {{ entry.local_count }}
                            {% endif %}
                        </td>

                        <td style="text-align:left;">
                            <form action="/gallery/dashboard/test" method="get" style="margin:0;display:inline;">
                                <input type="hidden" name="folder" value="{{ entry.key }}">
                                <input type="hidden" name="direction" value="reloadcache">
                                <button type="submit"
                                        style="background:none;border:none;color:inherit;cursor:pointer;">
                                    üîÅ {{ entry.db_count }}
                                </button>
                            </form>
                        </td>

                        <td>
                            {% if has_count_mismatch or has_gdrive_mismatch %}
                                {% if has_gdrive_mismatch %}
                                    <span class="count-badge-error">Hashfile-Mismatch</span>
                                {% elif has_count_mismatch %}
                                    <span class="count-badge-warn">DB-Mismatch</span>
                                {% endif %}
                            {% else %}
                                <span class="count-badge-ok">OK</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                {% if not gdrive_stats %}
                    <tr>
                        <td colspan="7" style="text-align:center; color:#6b7280; padding:10px;">
                            Keine Daten verf√ºgbar.
                        </td>
                    </tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {# ============================
       Kosten-Chart
       ============================ #}
    <h2 style="margin-top:30px;">Kostenverlauf</h2>
    <!-- ‚≠ê NEUE Position der Monatsnavigation -->
    <div class="nav-months" style="margin: 10px 0 20px 0; display:flex; gap:12px; align-items:center;">
        <a href="{{ nav.prev }}" class="btn-small">‚óÄ Vorheriger Monat</a>
        <span style="font-size:1.2rem; font-weight:600;">{{ nav.current }}</span>
        <a href="{{ nav.next }}" class="btn-small">N√§chster Monat ‚ñ∂</a>
    </div>
    <div class="card">
        <div class="card-header">
            <h3>Verlauf der monatlichen Kosten</h3>
            <small>Statische Ansicht f√ºr den ausgew√§hlten Monat</small>
        </div>
        <div style="height: 220px;">
            <canvas id="costChart"></canvas>
        </div>
    </div>

</div>

{% include "dashboard_scripts.j2" %}

</body>
</html>
