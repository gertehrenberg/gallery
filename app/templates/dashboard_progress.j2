<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Fortschritt</title>

    {% include "diff_gdrive_local_css.j2" %}
</head>

<body class="page">

<h1>Dateiübertragung – Fortschritt</h1>

<!-- Hauptfortschritt -->
<div class="card">
    <div class="card-header">
        <h3>Status</h3>
        <small id="mainPercent">0%</small>
    </div>

    <div id="status" class="muted" style="margin-bottom:8px;">Warte auf Start...</div>

    <div class="progress-bar-bg">
        <div id="progressBar" class="progress-bar" style="width:0%;"></div>
    </div>
</div>

<!-- Detailfortschritt -->
<div class="card">
    <div class="card-header">
        <h3>Details</h3>
        <small id="detailPercent">0%</small>
    </div>

    <div id="detailStatus" class="muted" style="margin-bottom:8px;">Details: -</div>

    <div class="progress-bar-bg" style="height:14px;">
        <div id="detailProgressBar" class="detail-bar" style="width:0%;height:100%;"></div>
    </div>
</div>

<!-- Button + Zeit -->
<div class="card">
    <button id="startButton" class="btn btn-blue" onclick="startTransfer()">
        {{ button_text }}
    </button>
    <div id="timeEstimate" class="muted" style="margin-top:8px;"></div>
</div>

<script>
    const START_URL = "{{ start_url }}";
    const PROGRESS_URL = "{{ progress_url }}";
    const FOLDER = "{{ folder_name }}";
    const DIRECTION = "{{ direction }}";

    let interval = null;
    let startTime = null;

    async function startTransfer() {
        const startButton = document.getElementById('startButton');
        startButton.disabled = true;
        startTime = Date.now();

        const formData = new FormData();
        formData.append("folder", FOLDER);
        formData.append("direction", DIRECTION);

        try {
            const response = await fetch(START_URL, { method: "POST", body: formData });
            if (!response.ok) throw new Error("HTTP " + response.status);

            if (!interval) interval = setInterval(updateProgress, 200);

        } catch (error) {
            document.getElementById("status").textContent = "❌ Fehler: " + error.message;
            startButton.disabled = false;
        }
    }

    function updateTimeEstimate(progress) {
        if (!startTime || progress <= 0) return;

        const elapsed = (Date.now() - startTime) / 1000;
        const total = elapsed * (100 / progress);
        const remaining = total - elapsed;

        const m = Math.floor(remaining / 60);
        const s = Math.floor(remaining % 60);

        document.getElementById('timeEstimate').textContent =
            `Geschätzte Restzeit: ${m}m ${s}s`;
    }

    async function updateProgress() {
        try {
            const response = await fetch(PROGRESS_URL);
            const data = await response.json();

            // Main progress
            const mainProgress = data.progress || 0;
            document.getElementById("status").textContent = data.status;
            document.getElementById("progressBar").style.width = mainProgress + "%";
            document.getElementById("mainPercent").textContent = mainProgress + "%";

            updateTimeEstimate(mainProgress);

            // Details
            if (data.details) {
                document.getElementById("detailStatus").textContent = data.details.status || "Details: -";

                if (data.details.progress !== undefined) {
                    const d = data.details.progress;
                    document.getElementById("detailProgressBar").style.width = d + "%";
                    document.getElementById("detailPercent").textContent = d + "%";
                }
            }

            // Completed
            if (data.status === "Abgeschlossen.") {
                clearInterval(interval);
                interval = null;
                document.getElementById("timeEstimate").textContent = "Fertig!";
                setTimeout(() => window.location.href = "/gallery/dashboard", 600);
            }

        } catch (error) {
            document.getElementById("status").textContent = "⚠️ Fehler: " + error.message;
        }
    }
</script>

</body>
</html>
