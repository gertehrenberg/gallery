<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Cross-Folder Cleanup</title>

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }

        .btn { padding: 8px 16px; font-size: 15px; border-radius: 6px; cursor: pointer;
               font-weight: 600; border: none; transition: background 0.2s; }

        .dashboard-btn { background: #0275d8; color: white; }
        .dashboard-btn:hover { background: #025aa5; }

        .reload-btn { background: #f0ad4e; color: white; }
        .reload-btn:hover { background: #ec971f; }

        .delete-btn { background: #d9534f; color: white; }
        .delete-btn:hover { background: #c9302c; }

        #progressBox { display: none; background: #fff; padding: 20px; border-radius: 8px;
                       margin: 20px 0; box-shadow: 0 0 8px rgba(0,0,0,0.1); }

        .progress-bar-bg { width: 100%; height: 22px; background: #ddd;
                           border-radius: 10px; overflow: hidden; margin: 6px 0; }

        .progress-bar { height: 22px; width: 0%; background: #0275d8;
                        transition: width 0.3s ease; }

        .detail-bar { background: #5cb85c; }

        table { width: 100%; margin-top: 20px; background: white;
                border-collapse: collapse; border-radius: 6px; overflow: hidden; }

        th, td { padding: 10px; border-bottom: 1px solid #ddd; }
        th { background: #fafafa; font-weight: bold; }
    </style>
</head>
<body>

<h1>Cross-Folder â€“ MD5-Duplikate</h1>

<form action="/gallery/gdrive_crossduplicates_delete" method="post">

    <!-- Buttons -->
    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
        <button type="button" class="btn dashboard-btn"
                onclick="window.location.href='/gallery/dashboard'">ðŸ“Š Dashboard</button>

        <button id="reloadBtn" type="button" class="btn reload-btn"
                onclick="startReload()">ðŸ”„ Neu laden</button>

        <button id="deleteBtn" class="btn delete-btn" type="submit">
            ðŸ—‘ AusgewÃ¤hlte lÃ¶schen
        </button>
    </div>

    <!-- PROGRESS -->
    <div id="progressBox">
        <div id="progressText" style="font-weight: bold;">Starteâ€¦</div>

        <div class="progress-bar-bg">
            <div id="mainBar" class="progress-bar"></div>
        </div>

        <div id="detailText" style="font-size: 14px; margin-top: 10px;">â€“</div>

        <div class="progress-bar-bg">
            <div id="detailBar" class="progress-bar detail-bar"></div>
        </div>
    </div>

    {% if results %}
        <h2>Gefundene Dateien / Ordner</h2>
    {% endif %}

    {% if not results %}
        <p>Keine Ergebnisse â€“ bitte â€žNeu ladenâ€œ drÃ¼cken.</p>
    {% else %}
        <table>
            <thead>
            <tr>
                <th>Ordner</th>
                <th>Dateiname</th>
                <th>Thumbnail</th>
                <th>LÃ¶schen?</th>
            </tr>
            </thead>
            <tbody>
            {% for entry in results %}
                {% for f in entry.files %}
                <tr>
                    <td>{{ entry.folder }}</td>
                    <td>{{ f.name }}</td>
                    <td>
                        <img src="https://drive.google.com/thumbnail?id={{ f.id }}&sz=w200"
                             style="height:70px;border-radius:4px;border:1px solid #ccc;">
                    </td>
                    <td style="text-align:center;">
                        <input type="checkbox" name="delete_ids" value="{{ f.id }}">
                    </td>
                </tr>
                {% endfor %}
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
</form>


<script>
let progressTimer = null;

function updateProgress() {
    fetch("/gallery/gdrive_crossduplicates_progress")
        .then(r => r.json())
        .then(p => {
            document.getElementById("progressText").innerText = p.status;
            document.getElementById("mainBar").style.width = p.progress + "%";

            document.getElementById("detailText").innerText = p.details.status || "-";
            document.getElementById("detailBar").style.width =
                (p.details.progress * 5) + "%";  // 20 â†’ 100%

            if (p.progress >= 100) {
                clearInterval(progressTimer);
                progressTimer = null;

                document.getElementById("progressBox").style.display = "none";

                setTimeout(() => {
                    window.location.href = "/gallery/gdrive_crossduplicates";
                }, 400);
            }
        });
}

function startReload() {

    document.getElementById("progressBox").style.display = "block";

    document.getElementById("reloadBtn").disabled = true;
    document.getElementById("deleteBtn").disabled = true;

    fetch("/gallery/gdrive_crossduplicates_start", { method: "POST" })
        .then(r => r.json())
        .then(data => {

            if (!progressTimer)
                progressTimer = setInterval(updateProgress, 350);

        });
}
</script>

</body>
</html>
